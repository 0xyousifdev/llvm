name: Build LLVM Clang LLD for iOS

on:
  workflow_dispatch:

jobs:
  build-ios-llvm:
    runs-on: macos-latest

    steps:
    - name: Checkout LLVM
      uses: actions/checkout@v4
      with:
        repository: llvm/llvm-project
        ref: llvmorg-20.1.8
        fetch-depth: 1

    - name: Install dependencies
      run: |
        brew install cmake ninja wget

    - name: Detect iOS SDK
      run: |
        ROOTDIR="$(pwd)"
        wget https://github.com/xybp888/iOS-SDKs/releases/download/iOS-SDKs/iPhoneOS16.1.sdk.zip
        unzip iPhoneOS16.1.sdk.zip
        SDK_PATH="$ROOTDIR/iPhoneOS16.1.sdk"
        echo "SDK_PATH=$SDK_PATH" >> $GITHUB_ENV
        

    - name: LLVM host
      run: |
        ROOTDIR="$(pwd)"
        mkdir -p "$ROOTDIR/out/build-llvm-host"
        cd "$ROOTDIR/out/build-llvm-host"
        cmake -G Ninja "$ROOTDIR/llvm" \
          -DCMAKE_INSTALL_PREFIX="$ROOTDIR/out/host" \
          -DCMAKE_PREFIX_PATH="$ROOTDIR/out/host" \
          -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_TARGETS_TO_BUILD="AArch64" \
          -DLLVM_ENABLE_BINDINGS=OFF \
          -DLLVM_ENABLE_LIBEDIT=OFF \
          -DLLVM_ENABLE_LIBPFM=OFF \
          -DLLVM_ENABLE_LIBXML2=OFF \
          -DLLVM_ENABLE_OCAMLDOC=OFF \
          -DLLVM_ENABLE_PLUGINS=OFF \
          -DLLVM_ENABLE_PROJECTS="lld;clang" \
          -DLLVM_ENABLE_Z3_SOLVER=OFF \
          -DLLVM_ENABLE_ZSTD=OFF \
          -DLLVM_INCLUDE_UTILS=OFF \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_INCLUDE_EXAMPLES=OFF \
          -DLLVM_INCLUDE_BENCHMARKS=OFF \
          -DLLVM_INCLUDE_DOCS=OFF \
          -DLLVM_TOOL_LLVM_LTO2_BUILD=OFF \
          -DLLVM_TOOL_LLVM_LTO_BUILD=OFF \
          -DLLVM_TOOL_LTO_BUILD=OFF \
          -DLLVM_TOOL_REMARKS_SHLIB_BUILD=OFF \
          -DCLANG_BUILD_TOOLS=OFF \
          -DCLANG_INCLUDE_DOCS=OFF \
          -DCLANG_INCLUDE_TESTS=OFF \
          -DCLANG_TOOL_CLANG_IMPORT_TEST_BUILD=OFF \
          -DCLANG_TOOL_CLANG_LINKER_WRAPPER_BUILD=OFF \
          -DCLANG_TOOL_C_INDEX_TEST_BUILD=OFF \
          -DCLANG_TOOL_ARCMT_TEST_BUILD=OFF \
          -DCLANG_TOOL_C_ARCMT_TEST_BUILD=OFF \
          -DCLANG_TOOL_LIBCLANG_BUILD=OFF
          cmake --build . --target install -- -j$(sysctl -n hw.logicalcpu)

    - name: LLVM Target
      run: | 
        TARGET="arm64-apple-ios"
        MCPU="baseline"
        TARGET_OS_CMAKE="iOS"
        ROOTDIR="$(pwd)"
        mkdir -p "$ROOTDIR/out/build-llvm-$TARGET-$MCPU"
        cd "$ROOTDIR/out/build-llvm-$TARGET-$MCPU"
        cmake -G Ninja "$ROOTDIR/llvm" \
          -DCMAKE_INSTALL_PREFIX="$ROOTDIR/out/$TARGET-$MCPU" \
          -DCMAKE_PREFIX_PATH="$ROOTDIR/out/$TARGET-$MCPU" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_CROSSCOMPILING=True \
          -DCMAKE_SYSTEM_NAME="$TARGET_OS_CMAKE" \
          -DCMAKE_OSX_SYSROOT=$SDK_PATH \
          -DCMAKE_C_FLAGS="-fno-sanitize=all -s -target $TARGET" \
          -DCMAKE_CXX_FLAGS="-fno-sanitize=all -s -target $TARGET" \
          -DCMAKE_ASM_FLAGS="-fno-sanitize=all -s -target $TARGET" \
          -DCMAKE_LINK_DEPENDS_USE_LINKER=OFF \
          -DCMAKE_RC_COMPILER="$ROOTDIR/out/host/bin/llvm-rc" \
          -DCMAKE_AR="$ROOTDIR/out/host/bin/llvm-ar" \
          -DCMAKE_RANLIB="$ROOTDIR/out/host/bin/llvm-ranlib" \
          -DLLVM_ENABLE_PROJECTS="lld;clang" \
          -DLLVM_ENABLE_ZLIB=FORCE_ON \
          -DLLVM_ENABLE_ZSTD=OFF \
          -DLLVM_USE_STATIC_ZSTD=OFF \
          -DLLVM_BUILD_LLVM_DYLIB=ON \
          -DLLVM_BUILD_STATIC=OFF \
          -DLLVM_TABLEGEN="$ROOTDIR/out/host/bin/llvm-tblgen" \
          -DCLANG_TABLEGEN="$ROOTDIR/out/host/bin/clang-tblgen" \
          -DLLVM_DEFAULT_TARGET_TRIPLE="$TARGET"
        cmake --build . --target install -- -j$(sysctl -n hw.logicalcpu)

    
    - name: Upload LLVM iOS toolchain
      uses: actions/upload-artifact@v4
      with:
        name: llvm-clang-lld-ios
        path: out/arm64-apple-ios*
